{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# Install Homebrew and packages (re-runs when this script changes)
set -euo pipefail

# ===== sudo keep-alive（Cask 安裝需要）=====
if ! sudo -n true 2>/dev/null; then
    echo "需要 sudo 權限安裝 Cask 應用..."
    sudo -v
fi
while true; do sudo -n true; sleep 60; kill -0 "$$" 2>/dev/null || exit; done &

# ===== Install Homebrew =====
if ! command -v brew &>/dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Setup PATH for Apple Silicon
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

echo "✓ Homebrew ready"

{{- if index . "is_work" }}
# 公司機器：Cask 安裝到個人 ~/Applications（避免權限問題）
mkdir -p "$HOME/Applications"
export HOMEBREW_CASK_OPTS="--appdir=$HOME/Applications"
{{- end }}

# ===== Base Brewfile =====
brew bundle --file=/dev/stdin <<'BREWFILE'
# CLI 工具
brew "age"           # 加密工具
brew "git"
brew "git-lfs"
brew "diff-so-fancy"
brew "fzf"
brew "ripgrep"
brew "fd"
brew "bat"
brew "eza"
brew "jq"
brew "tree"
brew "wget"
brew "gpg"
brew "gh"
brew "zoxide"
brew "htop"          # 系統監控
brew "tldr"          # 簡化版 man pages
brew "prettyping"    # 美化 ping
brew "uv"            # Python 套件管理
brew "mkcert"        # 本地 HTTPS 憑證
brew "ffmpeg"        # 影音處理

# 容器工具
brew "docker"
brew "docker-completion"

# 開發工具
brew "node"
brew "python"
brew "mise"          # 語言版本管理（取代 asdf）

# Cask 應用
cask "bitwarden"
cask "iterm2"
cask "visual-studio-code"
cask "orbstack"      # Docker Desktop 替代方案
cask "postman"       # API 測試
cask "claude"        # Claude Desktop
cask "arc"           # Arc 瀏覽器
cask "google-chrome" # Chrome 瀏覽器
cask "comet"         # Comet
cask "antigravity"   # Google Antigravity

# 字型
cask "font-noto-sans-cjk-tc"
cask "font-source-code-pro"
BREWFILE

echo "✓ Base packages installed"

# ===== Host-specific Brewfile =====
# Check if host-specific Brewfile exists in chezmoi source
HOSTNAME=$(hostname -s)
HOST_BREWFILE="{{ .chezmoi.sourceDir }}/hosts/${HOSTNAME}/Brewfile"
if [[ -f "$HOST_BREWFILE" ]]; then
    echo "Installing host-specific packages for ${HOSTNAME}..."
    brew bundle --file="$HOST_BREWFILE"
    echo "✓ Host-specific packages installed"
fi

echo "✓ All Homebrew packages installed"
{{ end -}}
