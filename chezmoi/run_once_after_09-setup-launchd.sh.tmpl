{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# Setup launchd agents for auto-sync
set -euo pipefail

LAUNCH_AGENTS="$HOME/Library/LaunchAgents"
mkdir -p "$LAUNCH_AGENTS"

# ===== chezmoi auto-update agent =====
CHEZMOI_PLIST="$LAUNCH_AGENTS/com.user.chezmoi-update.plist"
CHEZMOI_BIN="$(command -v chezmoi)"

cat > "$CHEZMOI_PLIST" << PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.user.chezmoi-update</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>-c</string>
        <string>${CHEZMOI_BIN} update --no-tty 2&gt;&amp;1 || osascript -e 'display notification "chezmoi update failed — check /tmp/chezmoi-update.err.log" with title "Dotfiles Sync"'</string>
    </array>
    <key>StartInterval</key>
    <integer>43200</integer>
    <key>RunAtLoad</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/tmp/chezmoi-update.out.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/chezmoi-update.err.log</string>
</dict>
</plist>
PLIST

launchctl unload "$CHEZMOI_PLIST" 2>/dev/null || true
launchctl load "$CHEZMOI_PLIST"
echo "✓ chezmoi auto-update agent installed (every 12 hours)"

# ===== iCloud capture agent =====
ICLOUD_SYNC="{{ .chezmoi.sourceDir }}/scripts/icloud-sync.sh"
if [[ -f "$ICLOUD_SYNC" ]]; then
    ICLOUD_PLIST="$LAUNCH_AGENTS/com.user.icloud-capture.plist"

    cat > "$ICLOUD_PLIST" << PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.user.icloud-capture</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>-c</string>
        <string>${ICLOUD_SYNC} capture 2&gt;&amp;1 || osascript -e 'display notification "iCloud capture failed — check /tmp/icloud-capture.err.log" with title "Dotfiles Sync"'</string>
    </array>
    <key>StartInterval</key>
    <integer>21600</integer>
    <key>RunAtLoad</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/tmp/icloud-capture.out.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/icloud-capture.err.log</string>
</dict>
</plist>
PLIST

    launchctl unload "$ICLOUD_PLIST" 2>/dev/null || true
    launchctl load "$ICLOUD_PLIST"
    echo "✓ iCloud capture agent installed (every 6 hours)"
fi

# ===== gpg-agent auto-start =====
GPG_PLIST="$LAUNCH_AGENTS/com.user.gpg-agent.plist"
GPGCONF_BIN="$(command -v gpgconf)"

cat > "$GPG_PLIST" << PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.user.gpg-agent</string>
    <key>ProgramArguments</key>
    <array>
        <string>${GPGCONF_BIN}</string>
        <string>--launch</string>
        <string>gpg-agent</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/tmp/gpg-agent.out.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/gpg-agent.err.log</string>
</dict>
</plist>
PLIST

launchctl unload "$GPG_PLIST" 2>/dev/null || true
launchctl load "$GPG_PLIST"
echo "✓ gpg-agent auto-start agent installed"

echo "✓ LaunchAgents setup complete"
{{ end -}}
