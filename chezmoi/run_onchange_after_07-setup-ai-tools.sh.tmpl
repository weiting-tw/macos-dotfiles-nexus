{{- if and (eq .chezmoi.os "darwin") (hasKey . "has_ai_tools") .has_ai_tools -}}
#!/bin/bash
# Setup AI Coding Tools + iCloud sync
set -euo pipefail

ICLOUD_DIR="{{ .icloud_dir }}"
CHEZMOI_SOURCE="{{ .chezmoi.sourceDir }}"

# ===== Create iCloud sync directory =====
mkdir -p "$ICLOUD_DIR"
mkdir -p "$ICLOUD_DIR"/{claude/{agents,skills},codex/skills,opencode/{agent,plugin,superpowers},vscode,iterm2}

echo "✓ iCloud sync directory ready: $ICLOUD_DIR"

# ===== Detect + Install AI tools =====
install_if_missing() {
    local name="$1" check="$2" install_cmd="$3"
    if command -v "$check" &>/dev/null || [[ -d "$check" ]]; then
        echo "✓ $name already installed"
    else
        read -p "Install $name? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            eval "$install_cmd"
            echo "✓ $name installed"
        else
            echo "⊘ $name skipped"
        fi
    fi
}

install_if_missing "Cursor"      "/Applications/Cursor.app"    "brew install --cask cursor"
install_if_missing "Windsurf"    "/Applications/Windsurf.app"  "brew install --cask windsurf"
install_if_missing "Claude Code" "claude"                       "npm install -g @anthropic-ai/claude-code"
install_if_missing "Codex"       "codex"                        "npm install -g @openai/codex"
install_if_missing "OpenCode"    "opencode"                     "brew install opencode"

# ===== Delegate iCloud sync to icloud-sync.sh =====
if [[ -x "$CHEZMOI_SOURCE/scripts/icloud-sync.sh" ]]; then
    bash "$CHEZMOI_SOURCE/scripts/icloud-sync.sh" apply
else
    echo "⚠ icloud-sync.sh not found, skipping symlink creation"
fi

# ===== OpenCode: Install plugin dependencies =====
OPENCODE_DIR="$HOME/.config/opencode"
if command -v bun &>/dev/null && [[ -f "$OPENCODE_DIR/package.json" ]]; then
    echo "Installing OpenCode plugin dependencies..."
    cd "$OPENCODE_DIR" && bun install --frozen-lockfile 2>/dev/null || bun install
    echo "✓ OpenCode plugin dependencies installed"
fi

echo "✓ AI tools setup complete"
{{ end -}}
