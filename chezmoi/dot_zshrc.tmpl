# If you come from bash you might have to change your $PATH.
export PATH=$HOME/bin:/usr/local/bin:$HOME/.docker/bin:$PATH

{{- if .is_work }}
# 公司機器：Cask 安裝到 ~/Applications（避免權限問題）
export HOMEBREW_CASK_OPTS="--appdir=~/Applications"
{{- end }}

# ===== Antidote Plugin Manager =====
# 取代直接載入 oh-my-zsh，改用 Antidote 統一管理
# Plugin 清單在 ~/.zsh_plugins.txt
source "$HOME/.antidote/antidote.zsh"
antidote load "$HOME/.zsh_plugins.txt"
# User configuration

# export MANPATH="/usr/local/man:$MANPATH"

# You may need to manually set your language environment
# export LANG=en_US.UTF-8

# Preferred editor for local and remote sessions
# if [[ -n $SSH_CONNECTION ]]; then
#   export EDITOR='vim'
# else
#   export EDITOR='mvim'
# fi

# Compilation flags
# export ARCHFLAGS="-arch x86_64"

# ssh
# export SSH_KEY_PATH="~/.ssh/rsa_id"

# Set personal aliases, overriding those provided by oh-my-zsh libs,
# plugins, and themes. Aliases can be placed here, though oh-my-zsh
# users are encouraged to define aliases within the ZSH_CUSTOM folder.
# For a full list of active aliases, run `alias`.
#
# Example aliases
# alias zshconfig="mate ~/.zshrc"
# alias ohmyzsh="mate ~/.oh-my-zsh"
if [ -f ~/.bash_profile ]; then
  source ~/.bash_profile
fi

## alias
alias cls=clear
alias ping='prettyping --nolegend'
alias help='tldr'
alias top="htop"
### Beyond Compare
alias bc=bcomp
## HOMEBREW
[[ $PATH != */usr/local/sbin* ]] && export PATH="/usr/local/bin:/usr/local/sbin:$PATH"
[[ -e "/usr/local/opt/curl/bin" ]] && export PATH="/usr/local/opt/curl/bin:$PATH"
function up() {
  sudo -v
  brew update && brew doctor
  brew upgrade
  brew upgrade --cask
  brew outdated --cask --greedy --verbose | grep -v latest | awk '{print $1}' | xargs -I{} brew upgrade --cask --greedy {}
  brew cleanup
  hash npm 2>/dev/null && npm up -g
  hash mas 2>/dev/null && mas upgrade
  dotnet tool list -g | awk '{ print $1 }' | tail +3 | xargs -I % sh -c 'dotnet tool update -g %;'
}

## brew
alias bs='brew search'
alias bi='brew install'

## functions

### kill process with particular port
#### port: $1
killport() {
  PIDS=$(lsof -ti:$1)
  if [ -z "$PIDS" ]; then
    echo "No process is using port $1"
    return
  fi

  echo "Killing processes using port $1:"
  echo "$PIDS"
  echo "$PIDS" | xargs kill -9
}

gitNameChange() {
  local OLD_EMAIL="${1:?用法: gitNameChange OLD_EMAIL NEW_NAME NEW_EMAIL}"
  local CORRECT_NAME="${2:?}"
  local CORRECT_EMAIL="${3:?}"
  git filter-branch --env-filter "
  if [ \"\$GIT_COMMITTER_EMAIL\" = \"$OLD_EMAIL\" ]; then
    export GIT_COMMITTER_NAME=\"$CORRECT_NAME\"
    export GIT_COMMITTER_EMAIL=\"$CORRECT_EMAIL\"
  fi
  if [ \"\$GIT_AUTHOR_EMAIL\" = \"$OLD_EMAIL\" ]; then
    export GIT_AUTHOR_NAME=\"$CORRECT_NAME\"
    export GIT_AUTHOR_EMAIL=\"$CORRECT_EMAIL\"
  fi
  " --tag-name-filter cat -- --branches --tags
}


# 定義備份並刪除文件的函數
backup_and_remove() {
    SOURCE="$1"
    DESTINATION="$2"

    echo "來源目錄: $SOURCE"
    echo "目標目錄: $DESTINATION"

    # 確保來源目錄存在
    if [ ! -d "$SOURCE" ]; then
        echo "來源目錄不存在：$SOURCE"
        return 1
    fi

    # 遞迴複製並刪除
    for file in "$SOURCE"*; do
        if [ -d "$file" ]; then  # 檢查是否為目錄
            echo "發現目錄，遞迴處理：$file"
            backup_and_remove "$file/" "$DESTINATION"
            if [ $? -eq 0 ]; then
                echo "複製成功，正在刪除目錄：$file"
                rmdir "$file"  # 刪除空目錄
            else
                echo "複製目錄失敗：$file"
            fi
        elif [ -f "$file" ]; then  # 檢查是否為文件
            echo "正在複製文件：$file"
            rsync -av --progress "$file" "$DESTINATION"
            if [ $? -eq 0 ]; then
                echo "複製成功，正在刪除：$file"
                rm "$file"  # 刪除原文件
            else
                echo "複製失敗：$file"
            fi
        else
            echo "檔案不存在或不是常規檔案：$file"
        fi
    done
}



test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"

export GPG_TTY=$(tty)

# To install useful key bindings and fuzzy completion:
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
#$(brew --prefix)/opt/fzf/install

#fpath=(/usr/local/share/zsh-completions $fpath)

# source /usr/local/share/zsh-history-substring-search/zsh-history-substring-search.zsh
# source /usr/local/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
# source /usr/local/share/zsh-autosuggestions/zsh-autosuggestions.zsh

# source ~/.antigenrc

alias download='axel -n 2'

alias preview="fzf --preview 'bat --style=numbers --color=\"always\" {}'"
[[ -x "$HOME/better-rm/better-rm" ]] && alias rm='~/better-rm/better-rm'


export FZF_CTRL_T_OPTS="--preview '(highlight -O ansi -l {} 2> /dev/null || cat {} || tree -C {}) 2> /dev/null'"

# azure-cli
autoload -U +X bashcompinit && bashcompinit
# source /usr/local/etc/bash_completion.d/az

complete -o nospace -C /usr/local/bin/mc mc

# eval "$(bw completion --shell zsh); compdef _bw bw;"

export PATH="${HOMEBREW_PREFIX}/opt/openssl/bin:$PATH"

# 確保本地安裝的 gem 可以順利使用
export PATH="$HOME/.gem/ruby/2.6.0/bin:$PATH"
export PATH="/opt/homebrew/opt/libpq/bin:$PATH"
export USE_AZURE=true

# === 敏感環境變數已移至 ~/.secrets ===
[[ -f ~/.secrets ]] && source ~/.secrets
export PATH="/opt/homebrew/opt/openjdk/bin:$PATH"

alias ai-review='codegpt review --lang=zh-tw'
alias ai-commit='codegpt commit --lang=zh-tw'
alias g='gemini -y -m gemini-3-pro-preview-11-2025'
alias cc='claude --allow-dangerously-skip-permissions'
alias oc='omnara --base-url "${OMNARA_BASE_URL}" --permission-mode bypassPermissions'
alias ocx='omnara --base-url "${OMNARA_BASE_URL}" --agent=codex --permission-mode bypassPermissions'

[[ -d "$HOME/miniconda3" ]] && export PATH="$HOME/miniconda3/bin:$PATH"
export EDITOR="code"

# zoxide (smart cd)
eval "$(zoxide init zsh)"

# Android Development
if [[ -d "$HOME/Library/Android/sdk" ]]; then
    export ANDROID_HOME="$HOME/Library/Android/sdk"
    export PATH=$PATH:$ANDROID_HOME/emulator
    export PATH=$PATH:$ANDROID_HOME/tools
    export PATH=$PATH:$ANDROID_HOME/tools/bin
    export PATH=$PATH:$ANDROID_HOME/platform-tools
fi

# Java (動態偵測版本)
if [[ -d "/opt/homebrew/opt/openjdk@17" ]]; then
    export JAVA_HOME="/opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk/Contents/Home"
    export PATH="/opt/homebrew/opt/openjdk@17/bin:$PATH"
fi
# codegpt
export PATH="$HOME/.codegpt/bin:$PATH"
#omnara
#export OMNARA_API_KEY="$(jq -r .write_key ~/.omnara/credentials.json)"
# OMNARA_BASE_URL 定義在 ~/.secrets

# bitwarden ssh agent
export SSH_AUTH_SOCK="$HOME/.bitwarden-ssh-agent.sock"

# Added by Antigravity
export PATH="$HOME/.antigravity/antigravity/bin:$PATH"
#uv
export PATH="$HOME/.local/bin:$PATH"
